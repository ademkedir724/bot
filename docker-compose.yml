# docker-compose.yml
version: '3.8'

services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: botuser
      POSTGRES_PASSWORD: botpassword
      POSTGRES_DB: anonbotdb
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U botuser -d anonbotdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  bot:
    build: .
    depends_on:
      db:
        condition: service_healthy
    # The .env file in the same directory will be automatically used
    # to substitute variables here.
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - GROUP_CHAT_ID=${GROUP_CHAT_ID}
      - DATABASE_URL=postgresql://botuser:botpassword@db:5432/anonbotdb
      - RATE_LIMIT_SECONDS=${RATE_LIMIT_SECONDS:-120}
      - PROFANITY_WORDS=${PROFANITY_WORDS:-""}
    command: |
      sh -c "
        echo '--- Waiting for database to be ready...'
        echo '--- Running database migrations...'
        python -m app.migrate
        echo '--- Starting the bot...'
        python -m app.main
      "

volumes:
  db_data:
    # This named volume persists database data across container restarts
    driver: local
